name: ìë™ ê·œì • ì—…ë°ì´íŠ¸

on:
  # ìˆ˜ë™ ì‹¤í–‰ (GitHub Actions íƒ­ì—ì„œ ë²„íŠ¼ í´ë¦­)
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'ì»¤ë°‹ ë©”ì‹œì§€ (ì„ íƒ)'
        required: false
        default: 'ê·œì • ìë™ ì—…ë°ì´íŠ¸'

  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ìë™ ì‹¤í–‰ (KST ê¸°ì¤€)
  schedule:
    - cron: '0 0 * * *'  # UTC 0ì‹œ = KST 9ì‹œ

  # regulations_source/newì— PDF/DOCX íŒŒì¼ì´ í‘¸ì‹œë˜ë©´ ì‹¤í–‰
  push:
    paths:
      - 'regulations_source/new/*.pdf'
      - 'regulations_source/new/*.docx'

jobs:
  auto-update:
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Pandoc ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: regulations_source/new í´ë” í™•ì¸
        id: check_files
        run: |
          if [ -d "regulations_source/new" ] && { ls regulations_source/new/*.pdf regulations_source/new/*.docx 1>/dev/null 2>&1; }; then
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "âœ… ì²˜ë¦¬í•  PDF/DOCX íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤."
            ls -la regulations_source/new/
          else
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ ì²˜ë¦¬í•  PDF/DOCX íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: regulations.json í™•ì¸ ë° ìƒì„±
        run: |
          if [ ! -f "regulations.json" ]; then
            echo "âš ï¸  regulations.jsonì´ ì—†ìŠµë‹ˆë‹¤. ìƒì„± ì¤‘..."
            python3 scripts/regenerate_regulations_db.py
          else
            echo "âœ… regulations.jsonì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          fi

      - name: ê·œì • íŒŒì¼ ì²˜ë¦¬
        if: steps.check_files.outputs.has_files == 'true'
        run: |
          echo "ğŸ“‚ regulations_source/new/ í´ë”ì˜ PDF/DOCX íŒŒì¼ ì²˜ë¦¬ ì¤‘..."
          for file in regulations_source/new/*.pdf regulations_source/new/*.docx; do
            if [ -f "$file" ]; then
              echo ""
              echo "=========================================="
              echo "ì²˜ë¦¬ ì¤‘: $file"
              echo "=========================================="
              python3 scripts/process_regulation.py "$file"
            fi
          done

      - name: regulations.json ìë™ ì¬ìƒì„±
        if: steps.check_files.outputs.has_files == 'true'
        run: |
          echo "ğŸ”„ regulations.json ì¬ìƒì„± ì¤‘..."
          python3 scripts/regenerate_regulations_db.py

      - name: RAG í´ë” ë™ê¸°í™”
        if: steps.check_files.outputs.has_files == 'true'
        run: |
          echo "ğŸ”„ RAG í´ë” ë™ê¸°í™” ì¤‘..."
          python3 scripts/sync_rag_folder.py

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain regulations/ regulations.json regulations_for_rag/ reports/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… ë³€ê²½ëœ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤."
            git status --short regulations/ regulations.json regulations_for_rag/ reports/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Git ì„¤ì •
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add regulations/ regulations.json regulations_for_rag/ reports/

          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="ìë™ ê·œì • ì—…ë°ì´íŠ¸ (í†µí•© ì‹œìŠ¤í…œ) - $(date +%Y-%m-%d)"
          fi

          git commit -m "$COMMIT_MSG"
          git push

      - name: ì‘ì—… ì™„ë£Œ
        run: |
          echo "=========================================="
          echo "âœ… ìë™ ê·œì • ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "=========================================="
          echo ""
          echo "ì²˜ë¦¬ ê²°ê³¼:"
          echo "  - ë³€ê²½ëœ íŒŒì¼: ${{ steps.check_changes.outputs.has_changes == 'true' && 'ìˆìŒ' || 'ì—†ìŒ' }}"
          echo ""
